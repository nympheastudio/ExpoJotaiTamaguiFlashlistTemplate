{"version":3,"file":"nativelinkederrors.js","sourceRoot":"","sources":["../../../src/js/integrations/nativelinkederrors.ts"],"names":[],"mappings":"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","sourcesContent":["import { exceptionFromError } from '@sentry/browser';\nimport type {\n  Client,\n  DebugImage,\n  Event,\n  EventHint,\n  EventProcessor,\n  Exception,\n  ExtendedError,\n  Hub,\n  Integration,\n  StackFrame,\n  StackParser,\n} from '@sentry/types';\nimport { isInstanceOf, isPlainObject } from '@sentry/utils';\n\nimport type { NativeStackFrames } from '../NativeRNSentry';\nimport { NATIVE } from '../wrapper';\n\nconst DEFAULT_KEY = 'cause';\nconst DEFAULT_LIMIT = 5;\n\ninterface LinkedErrorsOptions {\n  key: string;\n  limit: number;\n}\n\n/**\n * Processes JS and RN native linked errors.\n */\nexport class NativeLinkedErrors implements Integration {\n  /**\n   * @inheritDoc\n   */\n  public static id: string = 'NativeLinkedErrors';\n\n  /**\n   * @inheritDoc\n   */\n  public name: string = NativeLinkedErrors.id;\n\n  private readonly _key: LinkedErrorsOptions['key'];\n  private readonly _limit: LinkedErrorsOptions['limit'];\n  private _nativePackage: string | null = null;\n\n  /**\n   * @inheritDoc\n   */\n  public constructor(options: Partial<LinkedErrorsOptions> = {}) {\n    this._key = options.key || DEFAULT_KEY;\n    this._limit = options.limit || DEFAULT_LIMIT;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  public setupOnce(_addGlobalEventProcessor: (callback: EventProcessor) => void, _getCurrentHub: () => Hub): void {\n    /* noop */\n  }\n\n  /**\n   * @inheritDoc\n   */\n  public preprocessEvent(event: Event, hint: EventHint | undefined, client: Client): void {\n    if (this._nativePackage === null) {\n      this._nativePackage = this._fetchNativePackage();\n    }\n\n    this._handler(client.getOptions().stackParser, this._key, this._limit, event, hint);\n  }\n\n  /**\n   * Enriches passed event with linked exceptions and native debug meta images.\n   */\n  private _handler(parser: StackParser, key: string, limit: number, event: Event, hint?: EventHint): void {\n    if (!event.exception || !event.exception.values || !hint || !isInstanceOf(hint.originalException, Error)) {\n      return;\n    }\n    const { exceptions: linkedErrors, debugImages } = this._walkErrorTree(\n      parser,\n      limit,\n      hint.originalException as ExtendedError,\n      key,\n    );\n    event.exception.values = [...event.exception.values, ...linkedErrors];\n\n    event.debug_meta = event.debug_meta || {};\n    event.debug_meta.images = event.debug_meta.images || [];\n    event.debug_meta.images.push(...(debugImages || []));\n  }\n\n  /**\n   * Walks linked errors and created Sentry exceptions chain.\n   * Collects debug images from native errors stack frames.\n   */\n  private _walkErrorTree(\n    parser: StackParser,\n    limit: number,\n    error: ExtendedError,\n    key: string,\n    exceptions: Exception[] = [],\n    debugImages: DebugImage[] = [],\n  ): {\n    exceptions: Exception[];\n    debugImages?: DebugImage[];\n  } {\n    const linkedError = error[key];\n    if (!linkedError || exceptions.length + 1 >= limit) {\n      return {\n        exceptions,\n        debugImages,\n      };\n    }\n\n    let exception: Exception;\n    let exceptionDebugImages: DebugImage[] | undefined;\n    if ('stackElements' in linkedError) {\n      // isJavaException\n      exception = this._exceptionFromJavaStackElements(linkedError);\n    } else if ('stackReturnAddresses' in linkedError) {\n      // isObjCException\n      const { appleException, appleDebugImages } = this._exceptionFromAppleStackReturnAddresses(linkedError);\n      exception = appleException;\n      exceptionDebugImages = appleDebugImages;\n    } else if (isInstanceOf(linkedError, Error)) {\n      exception = exceptionFromError(parser, error[key]);\n    } else if (isPlainObject(linkedError)) {\n      exception = {\n        type: typeof linkedError.name === 'string' ? linkedError.name : undefined,\n        value: typeof linkedError.message === 'string' ? linkedError.message : undefined,\n      };\n    } else {\n      return {\n        exceptions,\n        debugImages,\n      };\n    }\n\n    return this._walkErrorTree(\n      parser,\n      limit,\n      linkedError,\n      key,\n      [...exceptions, exception],\n      [...debugImages, ...(exceptionDebugImages || [])],\n    );\n  }\n\n  /**\n   * Converts a Java Throwable to an SentryException\n   */\n  private _exceptionFromJavaStackElements(javaThrowable: {\n    name: string;\n    message: string;\n    stackElements: {\n      className: string;\n      fileName: string;\n      methodName: string;\n      lineNumber: number;\n    }[];\n  }): Exception {\n    return {\n      type: javaThrowable.name,\n      value: javaThrowable.message,\n      stacktrace: {\n        frames: javaThrowable.stackElements\n          .map(\n            stackElement =>\n              <StackFrame>{\n                platform: 'java',\n                module: stackElement.className,\n                filename: stackElement.fileName,\n                lineno: stackElement.lineNumber >= 0 ? stackElement.lineNumber : undefined,\n                function: stackElement.methodName,\n                in_app:\n                  this._nativePackage !== null && stackElement.className.startsWith(this._nativePackage)\n                    ? true\n                    : undefined,\n              },\n          )\n          .reverse(),\n      },\n    };\n  }\n\n  /**\n   * Converts StackAddresses to a SentryException with DebugMetaImages\n   */\n  private _exceptionFromAppleStackReturnAddresses(objCException: {\n    name: string;\n    message: string;\n    stackReturnAddresses: number[];\n  }): {\n    appleException: Exception;\n    appleDebugImages: DebugImage[];\n  } {\n    const nativeStackFrames = this._fetchNativeStackFrames(objCException.stackReturnAddresses);\n\n    return {\n      appleException: {\n        type: objCException.name,\n        value: objCException.message,\n        stacktrace: {\n          frames: (nativeStackFrames && nativeStackFrames.frames.reverse()) || [],\n        },\n      },\n      appleDebugImages: (nativeStackFrames && (nativeStackFrames.debugMetaImages as DebugImage[])) || [],\n    };\n  }\n\n  /**\n   * Fetches the native package/image name from the native layer\n   */\n  private _fetchNativePackage(): string | null {\n    return NATIVE.fetchNativePackageName();\n  }\n\n  /**\n   * Fetches native debug image information on iOS\n   */\n  private _fetchNativeStackFrames(instructionsAddr: number[]): NativeStackFrames | null {\n    return NATIVE.fetchNativeStackFramesBy(instructionsAddr);\n  }\n}\n"]}