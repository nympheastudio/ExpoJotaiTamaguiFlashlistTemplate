{"version":3,"file":"spotlight.js","sourceRoot":"","sources":["../../../src/js/integrations/spotlight.ts"],"names":[],"mappings":"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","sourcesContent":["import type { Client, Envelope, EventProcessor, Integration } from '@sentry/types';\nimport { logger, serializeEnvelope } from '@sentry/utils';\n\nimport { makeUtf8TextEncoder } from '../transports/TextEncoder';\nimport { ReactNativeLibraries } from '../utils/rnlibraries';\nimport { createStealthXhr, XHR_READYSTATE_DONE } from '../utils/xhr';\n\ntype SpotlightReactNativeIntegrationOptions = {\n  /**\n   * The URL of the Sidecar instance to connect and forward events to.\n   * If not set, Spotlight will try to connect to the Sidecar running on localhost:8969.\n   *\n   * @default \"http://localhost:8969/stream\"\n   */\n  sidecarUrl?: string;\n};\n\n/**\n * Use this integration to send errors and transactions to Spotlight.\n *\n * Learn more about spotlight at https://spotlightjs.com\n */\nexport function Spotlight({\n  sidecarUrl = getDefaultSidecarUrl(),\n}: SpotlightReactNativeIntegrationOptions = {}): Integration {\n  logger.info('[Spotlight] Using Sidecar URL', sidecarUrl);\n\n  return {\n    name: 'Spotlight',\n\n    setupOnce(_: (callback: EventProcessor) => void, getCurrentHub) {\n      const client = getCurrentHub().getClient();\n      if (client) {\n        setup(client, sidecarUrl);\n      } else {\n        logger.warn('[Spotlight] Could not initialize Sidecar integration due to missing Client');\n      }\n    },\n  };\n}\n\nfunction setup(client: Client, sidecarUrl: string): void {\n  sendEnvelopesToSidecar(client, sidecarUrl);\n}\n\nfunction sendEnvelopesToSidecar(client: Client, sidecarUrl: string): void {\n  if (!client.on) {\n    return;\n  }\n\n  client.on('beforeEnvelope', (originalEnvelope: Envelope) => {\n    // TODO: This is a workaround for spotlight/sidecar not supporting images\n    const spotlightEnvelope: Envelope = [...originalEnvelope];\n    const envelopeItems = [...originalEnvelope[1]].filter(\n      item => typeof item[0].content_type !== 'string' || !item[0].content_type.startsWith('image'),\n    );\n\n    spotlightEnvelope[1] = envelopeItems as Envelope[1];\n\n    const xhr = createStealthXhr();\n    if (!xhr) {\n      logger.error('[Spotlight] Sentry SDK can not create XHR object');\n      return;\n    }\n\n    xhr.open('POST', sidecarUrl, true);\n    xhr.setRequestHeader('Content-Type', 'application/x-sentry-envelope');\n\n    xhr.onreadystatechange = function () {\n      if (xhr.readyState === XHR_READYSTATE_DONE) {\n        const status = xhr.status;\n        if (status === 0 || (status >= 200 && status < 400)) {\n          // The request has been completed successfully\n        } else {\n          // Handle the error\n          logger.error(\n            \"[Spotlight] Sentry SDK can't connect to Spotlight is it running? See https://spotlightjs.com to download it.\",\n            new Error(xhr.statusText),\n          );\n        }\n      }\n    };\n\n    xhr.send(serializeEnvelope(spotlightEnvelope, makeUtf8TextEncoder()));\n  });\n}\n\nfunction getDefaultSidecarUrl(): string {\n  try {\n    const { url } = ReactNativeLibraries.Devtools?.getDevServer();\n    return `http://${getHostnameFromString(url)}:8969/stream`;\n  } catch (_oO) {\n    // We can't load devserver URL\n  }\n  return 'http://localhost:8969/stream';\n}\n\n/**\n * React Native implementation of the URL class is missing the `hostname` property.\n */\nfunction getHostnameFromString(urlString: string): string | null {\n  const regex = /^(?:\\w+:)?\\/\\/([^/:]+)(:\\d+)?(.*)$/;\n  const matches = urlString.match(regex);\n\n  if (matches && matches[1]) {\n    return matches[1];\n  } else {\n    // Invalid URL format\n    return null;\n  }\n}\n"]}