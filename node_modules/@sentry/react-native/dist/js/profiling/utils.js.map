{"version":3,"file":"utils.js","sourceRoot":"","sources":["../../../src/js/profiling/utils.ts"],"names":[],"mappings":"AAEA,OAAO,EAAE,mBAAmB,EAAE,MAAM,EAAE,MAAM,eAAe,CAAC;AAE5D,OAAO,EAAE,qBAAqB,EAAE,MAAM,sBAAsB,CAAC;AAC7D,OAAO,EAAE,gBAAgB,EAAE,MAAM,WAAW,CAAC;AAU7C;;GAEG;AACH,MAAM,UAAU,cAAc,CAAC,OAAyB;IACtD,IAAI,OAAO,CAAC,OAAO,CAAC,MAAM,IAAI,CAAC,EAAE;QAC/B,IAAI,OAAO,EAAE;YACX,6EAA6E;YAC7E,8EAA8E;YAC9E,gEAAgE;YAChE,MAAM,CAAC,GAAG,CAAC,wEAAwE,CAAC,CAAC;SACtF;QACD,OAAO,KAAK,CAAC;KACd;IACD,OAAO,IAAI,CAAC;AACd,CAAC;AAED;;;;GAIG;AACH,MAAM,UAAU,oCAAoC,CAAC,QAAkB;IACrE,MAAM,MAAM,GAAY,EAAE,CAAC;IAE3B,mBAAmB,CAAC,QAAQ,EAAE,CAAC,IAAI,EAAE,IAAI,EAAE,EAAE;QAC3C,IAAI,IAAI,KAAK,aAAa,EAAE;YAC1B,OAAO;SACR;QAED,yBAAyB;QACzB,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,IAAI,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;YACpC,MAAM,KAAK,GAAG,IAAI,CAAC,CAAC,CAAC,CAAC;YAEtB,8CAA8C;YAC9C,sEAAsE;YACtE,IAAI,KAAK,IAAI,KAAK,CAAC,QAAQ,IAAI,KAAK,CAAC,QAAQ,CAAC,SAAS,CAAC,IAAI,KAAK,CAAC,QAAQ,CAAC,SAAS,CAAC,CAAC,YAAY,CAAC,EAAE;gBACnG,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAU,CAAC,CAAC;aAC/B;SACF;IACH,CAAC,CAAC,CAAC;IAEH,OAAO,MAAM,CAAC;AAChB,CAAC;AAED;;;;GAIG;AACH,MAAM,UAAU,qCAAqC,CACnD,UAAkB,EAClB,OAA2D,EAC3D,KAAY;IAEZ,IAAI,YAAY,IAAI,OAAO,EAAE;QAC3B,OAAO,oCAAoC,CAAC,UAAU,EAAE,OAAO,EAAE,KAAK,CAAC,CAAC;KACzE;IAED,IAAI,CAAC,OAAO,CAAC,OAAO,IAAI,CAAC,cAAc,CAAC,OAAO,CAAC,OAAO,CAAC,EAAE;QACxD,OAAO,IAAI,CAAC;KACb;IAED,MAAM,QAAQ,GAAG,CAAC,KAAK,CAAC,QAAQ,IAAI,KAAK,CAAC,QAAQ,CAAC,KAAK,IAAI,KAAK,CAAC,QAAQ,CAAC,KAAK,CAAC,QAAQ,CAAC,IAAI,EAAE,CAAC;IAEjG,0EAA0E;IAC1E,gFAAgF;IAChF,8DAA8D;IAC9D,IAAI,QAAQ,IAAI,QAAQ,CAAC,MAAM,KAAK,EAAE,EAAE;QACtC,IAAI,OAAO,EAAE;YACX,MAAM,CAAC,GAAG,CAAC,gCAAgC,QAAQ,oBAAoB,CAAC,CAAC;SAC1E;KACF;IAED,uCACK,OAAO,KACV,QAAQ,EAAE,UAAU,EACpB,OAAO,EAAE;YACP,IAAI,EAAE,QAAQ;YACd,OAAO,EAAE,EAAE,EAAE,2BAA2B;SACzC,EACD,SAAS,EAAE,KAAK,CAAC,eAAe,CAAC,CAAC,CAAC,IAAI,IAAI,CAAC,KAAK,CAAC,eAAe,GAAG,IAAI,CAAC,CAAC,WAAW,EAAE,CAAC,CAAC,CAAC,IAAI,IAAI,EAAE,CAAC,WAAW,EAAE,EAClH,OAAO,EAAE,KAAK,CAAC,OAAO,IAAI,EAAE,EAC5B,WAAW,EAAE,KAAK,CAAC,WAAW,IAAI,qBAAqB,EAAE,EACzD,EAAE,EAAE;YACF,IAAI,EAAE,CAAC,KAAK,CAAC,QAAQ,IAAI,KAAK,CAAC,QAAQ,CAAC,EAAE,IAAI,KAAK,CAAC,QAAQ,CAAC,EAAE,CAAC,IAAI,CAAC,IAAI,EAAE;YAC3E,OAAO,EAAE,CAAC,KAAK,CAAC,QAAQ,IAAI,KAAK,CAAC,QAAQ,CAAC,EAAE,IAAI,KAAK,CAAC,QAAQ,CAAC,EAAE,CAAC,OAAO,CAAC,IAAI,EAAE;YACjF,YAAY,EAAE,CAAC,KAAK,CAAC,QAAQ,IAAI,KAAK,CAAC,QAAQ,CAAC,EAAE,IAAI,KAAK,CAAC,QAAQ,CAAC,EAAE,CAAC,KAAK,CAAC,IAAI,EAAE;SACrF,EACD,MAAM,EAAE;YACN,MAAM,EAAE,CAAC,KAAK,CAAC,QAAQ,IAAI,KAAK,CAAC,QAAQ,CAAC,MAAM,IAAK,KAAK,CAAC,QAAQ,CAAC,MAAM,CAAC,MAAiB,CAAC,IAAI,EAAE;YACnG,KAAK,EAAE,CAAC,KAAK,CAAC,QAAQ,IAAI,KAAK,CAAC,QAAQ,CAAC,MAAM,IAAI,KAAK,CAAC,QAAQ,CAAC,MAAM,CAAC,KAAK,CAAC,IAAI,EAAE;YACrF,YAAY,EAAE,CAAC,KAAK,CAAC,QAAQ,IAAI,KAAK,CAAC,QAAQ,CAAC,MAAM,IAAI,KAAK,CAAC,QAAQ,CAAC,MAAM,CAAC,YAAY,CAAC,IAAI,EAAE;YACnG,YAAY,EAAE,CAAC,KAAK,CAAC,QAAQ,IAAI,KAAK,CAAC,QAAQ,CAAC,MAAM,IAAI,KAAK,CAAC,QAAQ,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,EAAE;YAC3F,WAAW,EAAE,CAAC,KAAK,CAAC,QAAQ,IAAI,KAAK,CAAC,QAAQ,CAAC,MAAM,IAAI,KAAK,CAAC,QAAQ,CAAC,MAAM,CAAC,SAAS,CAAC,IAAI,KAAK;SACnG,EACD,WAAW,EAAE;YACX,IAAI,EAAE,KAAK,CAAC,WAAW,IAAI,EAAE;YAC7B,EAAE,EAAE,KAAK,CAAC,QAAQ,IAAI,EAAE;YACxB,QAAQ;YACR,gBAAgB,EAAE,CAAC,OAAO,CAAC,WAAW,IAAI,OAAO,CAAC,WAAW,CAAC,gBAAgB,CAAC,IAAI,EAAE;SACtF,EACD,UAAU,EAAE;YACV,MAAM,EAAE,CAAC,GAAG,gBAAgB,EAAE,EAAE,GAAG,CAAC,CAAC,OAAO,CAAC,UAAU,IAAI,OAAO,CAAC,UAAU,CAAC,MAAM,CAAC,IAAI,EAAE,CAAC,CAAC;SAC9F,IACD;AACJ,CAAC;AAED;;GAEG;AACH,MAAM,UAAU,oCAAoC,CAClD,UAAkB,EAClB,OAAoC,EACpC,KAAY;IAEZ,uCACK,OAAO,KACV,UAAU,EAAE;YACV,MAAM,EAAE,gBAAgB,EAAE;SAC3B,EACD,QAAQ,EAAE,OAAO,CAAC,QAAQ,IAAI,EAAE,EAEhC,sBAAsB,EAAE,EAAE,EAC1B,kBAAkB,EAAE,CAAC,KAAK,CAAC,QAAQ,IAAI,KAAK,CAAC,QAAQ,CAAC,MAAM,IAAI,KAAK,CAAC,QAAQ,CAAC,MAAM,CAAC,SAAS,CAAC,IAAI,KAAK,EACzG,aAAa,EAAE,CAAC,KAAK,CAAC,QAAQ,IAAI,KAAK,CAAC,QAAQ,CAAC,MAAM,IAAK,KAAK,CAAC,QAAQ,CAAC,MAAM,CAAC,MAAiB,CAAC,IAAI,EAAE,EAC1G,mBAAmB,EAAE,CAAC,KAAK,CAAC,QAAQ,IAAI,KAAK,CAAC,QAAQ,CAAC,MAAM,IAAI,KAAK,CAAC,QAAQ,CAAC,MAAM,CAAC,YAAY,CAAC,IAAI,EAAE,EAC1G,YAAY,EAAE,CAAC,KAAK,CAAC,QAAQ,IAAI,KAAK,CAAC,QAAQ,CAAC,MAAM,IAAI,KAAK,CAAC,QAAQ,CAAC,MAAM,CAAC,KAAK,CAAC,IAAI,EAAE,EAC5F,cAAc,EAAE,CAAC,KAAK,CAAC,QAAQ,IAAI,KAAK,CAAC,QAAQ,CAAC,EAAE,IAAI,KAAK,CAAC,QAAQ,CAAC,EAAE,CAAC,IAAI,CAAC,IAAI,EAAE,EACrF,iBAAiB,EAAE,CAAC,KAAK,CAAC,QAAQ,IAAI,KAAK,CAAC,QAAQ,CAAC,EAAE,IAAI,KAAK,CAAC,QAAQ,CAAC,EAAE,CAAC,OAAO,CAAC,IAAI,EAAE,EAE3F,4BAA4B,EAC1B,CAAC,KAAK,CAAC,QAAQ;YACb,KAAK,CAAC,QAAQ,CAAC,MAAM;YACrB,KAAK,CAAC,QAAQ,CAAC,MAAM,CAAC,WAAW;YACjC,MAAM,CAAC,KAAK,CAAC,QAAQ,CAAC,MAAM,CAAC,WAAW,CAAC,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC;YACzD,EAAE,EAEJ,WAAW,EAAE,KAAK,CAAC,WAAW,IAAI,qBAAqB,EAAE,EAEzD,UAAU,EAEV,SAAS,EAAE,KAAK,CAAC,eAAe,CAAC,CAAC,CAAC,IAAI,IAAI,CAAC,KAAK,CAAC,eAAe,GAAG,IAAI,CAAC,CAAC,WAAW,EAAE,CAAC,CAAC,CAAC,IAAI,IAAI,EAAE,CAAC,WAAW,EAAE,EAElH,OAAO,EAAE,KAAK,CAAC,OAAO,IAAI,EAAE,EAC5B,IAAI,EAAE,KAAK,CAAC,IAAI,IAAI,EAAE,EAEtB,cAAc,EAAE,KAAK,CAAC,QAAQ,IAAI,EAAE,EACpC,gBAAgB,EAAE,KAAK,CAAC,WAAW,IAAI,EAAE,EACzC,QAAQ,EAAE,CAAC,KAAK,CAAC,QAAQ,IAAI,KAAK,CAAC,QAAQ,CAAC,KAAK,IAAI,KAAK,CAAC,QAAQ,CAAC,KAAK,CAAC,QAAQ,CAAC,IAAI,EAAE,EAEzF,YAAY,EAAE,KAAK,CAAC,OAAO,IAAI,EAAE,EACjC,YAAY,EAAE,KAAK,CAAC,IAAI,IAAI,EAAE,IAC9B;AACJ,CAAC;AAED;;GAEG;AACH,MAAM,UAAU,0BAA0B,CAAC,OAA4B;IACrE,OAAO;QACL,QAAQ,EAAE,YAAY;QACtB,OAAO,EAAE,GAAG;QACZ,OAAO;QACP,WAAW,EAAE;YACX,gBAAgB,EAAE,OAAO,CAAC,gBAAgB;SAC3C;KACF,CAAC;AACJ,CAAC;AAED;;;GAGG;AACH,MAAM,UAAU,qBAAqB,CAAC,QAAkB,EAAE,QAAwB;IAChF,IAAI,CAAC,QAAQ,CAAC,MAAM,EAAE;QACpB,OAAO,QAAQ,CAAC;KACjB;IAED,KAAK,MAAM,OAAO,IAAI,QAAQ,EAAE;QAC9B,oCAAoC;QACpC,QAAQ,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,EAAE,IAAI,EAAE,SAAS,EAAE,EAAE,OAAO,CAAC,CAAC,CAAC;KAClD;IACD,OAAO,QAAQ,CAAC;AAClB,CAAC","sourcesContent":["/* eslint-disable complexity */\nimport type { Envelope, Event, ThreadCpuProfile } from '@sentry/types';\nimport { forEachEnvelopeItem, logger } from '@sentry/utils';\n\nimport { getDefaultEnvironment } from '../utils/environment';\nimport { getDebugMetadata } from './debugid';\nimport type {\n  AndroidCombinedProfileEvent,\n  AndroidProfileEvent,\n  CombinedProfileEvent,\n  HermesProfileEvent,\n  ProfileEvent,\n  RawThreadCpuProfile,\n} from './types';\n\n/**\n *\n */\nexport function isValidProfile(profile: ThreadCpuProfile): profile is RawThreadCpuProfile & { profile_id: string } {\n  if (profile.samples.length <= 1) {\n    if (__DEV__) {\n      // Log a warning if the profile has less than 2 samples so users can know why\n      // they are not seeing any profiling data and we cant avoid the back and forth\n      // of asking them to provide us with a dump of the profile data.\n      logger.log('[Profiling] Discarding profile because it contains less than 2 samples');\n    }\n    return false;\n  }\n  return true;\n}\n\n/**\n * Finds transactions with profile_id context in the envelope\n * @param envelope\n * @returns\n */\nexport function findProfiledTransactionsFromEnvelope(envelope: Envelope): Event[] {\n  const events: Event[] = [];\n\n  forEachEnvelopeItem(envelope, (item, type) => {\n    if (type !== 'transaction') {\n      return;\n    }\n\n    // First item is the type\n    for (let j = 1; j < item.length; j++) {\n      const event = item[j];\n\n      // @ts-expect-error accessing private property\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n      if (event && event.contexts && event.contexts['profile'] && event.contexts['profile']['profile_id']) {\n        events.push(item[j] as Event);\n      }\n    }\n  });\n\n  return events;\n}\n\n/**\n * Creates a profiling envelope item, if the profile does not pass validation, returns null.\n * @param event\n * @returns {ProfileEvent | null}\n */\nexport function enrichCombinedProfileWithEventContext(\n  profile_id: string,\n  profile: CombinedProfileEvent | AndroidCombinedProfileEvent,\n  event: Event,\n): ProfileEvent | null {\n  if ('js_profile' in profile) {\n    return enrichAndroidProfileWithEventContext(profile_id, profile, event);\n  }\n\n  if (!profile.profile || !isValidProfile(profile.profile)) {\n    return null;\n  }\n\n  const trace_id = (event.contexts && event.contexts.trace && event.contexts.trace.trace_id) || '';\n\n  // Log a warning if the profile has an invalid traceId (should be uuidv4).\n  // All profiles and transactions are rejected if this is the case and we want to\n  // warn users that this is happening if they enable debug flag\n  if (trace_id && trace_id.length !== 32) {\n    if (__DEV__) {\n      logger.log(`[Profiling] Invalid traceId: ${trace_id} on profiled event`);\n    }\n  }\n\n  return {\n    ...profile,\n    event_id: profile_id,\n    runtime: {\n      name: 'hermes',\n      version: '', // TODO: get hermes version\n    },\n    timestamp: event.start_timestamp ? new Date(event.start_timestamp * 1000).toISOString() : new Date().toISOString(),\n    release: event.release || '',\n    environment: event.environment || getDefaultEnvironment(),\n    os: {\n      name: (event.contexts && event.contexts.os && event.contexts.os.name) || '',\n      version: (event.contexts && event.contexts.os && event.contexts.os.version) || '',\n      build_number: (event.contexts && event.contexts.os && event.contexts.os.build) || '',\n    },\n    device: {\n      locale: (event.contexts && event.contexts.device && (event.contexts.device.locale as string)) || '',\n      model: (event.contexts && event.contexts.device && event.contexts.device.model) || '',\n      manufacturer: (event.contexts && event.contexts.device && event.contexts.device.manufacturer) || '',\n      architecture: (event.contexts && event.contexts.device && event.contexts.device.arch) || '',\n      is_emulator: (event.contexts && event.contexts.device && event.contexts.device.simulator) || false,\n    },\n    transaction: {\n      name: event.transaction || '',\n      id: event.event_id || '',\n      trace_id,\n      active_thread_id: (profile.transaction && profile.transaction.active_thread_id) || '',\n    },\n    debug_meta: {\n      images: [...getDebugMetadata(), ...((profile.debug_meta && profile.debug_meta.images) || [])],\n    },\n  };\n}\n\n/**\n * Creates Android profiling envelope item.\n */\nexport function enrichAndroidProfileWithEventContext(\n  profile_id: string,\n  profile: AndroidCombinedProfileEvent,\n  event: Event,\n): AndroidProfileEvent | null {\n  return {\n    ...profile,\n    debug_meta: {\n      images: getDebugMetadata(),\n    },\n    build_id: profile.build_id || '',\n\n    device_cpu_frequencies: [],\n    device_is_emulator: (event.contexts && event.contexts.device && event.contexts.device.simulator) || false,\n    device_locale: (event.contexts && event.contexts.device && (event.contexts.device.locale as string)) || '',\n    device_manufacturer: (event.contexts && event.contexts.device && event.contexts.device.manufacturer) || '',\n    device_model: (event.contexts && event.contexts.device && event.contexts.device.model) || '',\n    device_os_name: (event.contexts && event.contexts.os && event.contexts.os.name) || '',\n    device_os_version: (event.contexts && event.contexts.os && event.contexts.os.version) || '',\n\n    device_physical_memory_bytes:\n      (event.contexts &&\n        event.contexts.device &&\n        event.contexts.device.memory_size &&\n        Number(event.contexts.device.memory_size).toString(10)) ||\n      '',\n\n    environment: event.environment || getDefaultEnvironment(),\n\n    profile_id,\n\n    timestamp: event.start_timestamp ? new Date(event.start_timestamp * 1000).toISOString() : new Date().toISOString(),\n\n    release: event.release || '',\n    dist: event.dist || '',\n\n    transaction_id: event.event_id || '',\n    transaction_name: event.transaction || '',\n    trace_id: (event.contexts && event.contexts.trace && event.contexts.trace.trace_id) || '',\n\n    version_name: event.release || '',\n    version_code: event.dist || '',\n  };\n}\n\n/**\n * Creates profiling event compatible carrier Object from raw Hermes profile.\n */\nexport function createHermesProfilingEvent(profile: RawThreadCpuProfile): HermesProfileEvent {\n  return {\n    platform: 'javascript',\n    version: '1',\n    profile,\n    transaction: {\n      active_thread_id: profile.active_thread_id,\n    },\n  };\n}\n\n/**\n * Adds items to envelope if they are not already present - mutates the envelope.\n * @param envelope\n */\nexport function addProfilesToEnvelope(envelope: Envelope, profiles: ProfileEvent[]): Envelope {\n  if (!profiles.length) {\n    return envelope;\n  }\n\n  for (const profile of profiles) {\n    // @ts-expect-error untyped envelope\n    envelope[1].push([{ type: 'profile' }, profile]);\n  }\n  return envelope;\n}\n"]}