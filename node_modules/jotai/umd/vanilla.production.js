!function(n,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((n="undefined"!=typeof globalThis?globalThis:n||self).jotaiVanilla={})}(this,(function(n){"use strict";var e=0;function t(n){return n(this)}function r(n,e,t){return e(this,"function"==typeof t?t(n(this)):t)}function o(n,e){(null==e||e>n.length)&&(e=n.length);for(var t=0,r=Array(e);t<e;t++)r[t]=n[t];return r}function a(n,e){var t="undefined"!=typeof Symbol&&n[Symbol.iterator]||n["@@iterator"];if(t)return(t=t.call(n)).next.bind(t);if(Array.isArray(n)||(t=function(n,e){if(n){if("string"==typeof n)return o(n,e);var t={}.toString.call(n).slice(8,-1);return"Object"===t&&n.constructor&&(t=n.constructor.name),"Map"===t||"Set"===t?Array.from(n):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?o(n,e):void 0}}(n))||e){t&&(n=t);var r=0;return function(){return r>=n.length?{done:!0}:{done:!1,value:n[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,u=function(n,e){return n.unstable_is?n.unstable_is(e):e===n},f=function(n){return"init"in n},c=function(n){return!!n.write},l=Symbol(""),v="pending",d=new WeakMap,s=function(n){return"v"in n||"e"in n},m=function(n){if("e"in n)throw n.e;return n.v},y=function(n){var e,t=n.v;return"object"==typeof(e=t)&&null!==e&&l in e&&t.status===v?t:null},p=function(n,e,t){t.p.has(n)||(t.p.add(n),e.then((function(){t.p.delete(n)}),(function(){t.p.delete(n)})))},h=function(){return[new Map,new Map,new Set]},w=function(n,e,t){n[0].has(e)||n[0].set(e,new Set),n[1].set(e,t)},g=function(n,e){n[2].add(e)},b=function(n){for(;n[1].size||n[2].size;){n[0].clear();var e=new Set(n[1].values());n[1].clear();var t=new Set(n[2]);n[2].clear(),e.forEach((function(n){var e;return null==(e=n.m)?void 0:e.l.forEach((function(n){return n()}))})),t.forEach((function(n){return n()}))}},S=function(){var n=new WeakMap,e=function(e){var t=n.get(e);return t||(t={d:new Map,p:new Set,n:0},n.set(e,t)),t},t=function(n,t,r,o,i){void 0===o&&(o=function(){}),void 0===i&&(i=function(){});var u,f="v"in t,c=t.v,s=y(t);if("function"==typeof(null==(u=r)?void 0:u.then))if(s)s!==r&&(s[l](r,o),++t.n);else{var m=function(n,e,t){if(!d.has(n)){var r,o=new Promise((function(a,i){var u=n,f=function(n){return function(e){u===n&&(o.status="fulfilled",o.value=e,a(e),t())}},c=function(n){return function(e){u===n&&(o.status="rejected",o.reason=e,i(e),t())}};n.then(f(n),c(n)),r=function(n,t){n&&(d.set(n,o),u=n,n.then(f(n),c(n)),e(),e=t)}}));o.status=v,o[l]=r,d.set(n,o)}return d.get(n)}(r,o,i);if(m.status===v)for(var h,w=a(t.d.keys());!(h=w()).done;){var g=h.value,b=e(g);p(n,m,b)}t.v=m,delete t.e}else s&&s[l](Promise.resolve(r),o),t.v=r,delete t.e;f&&Object.is(c,t.v)||++t.n},r=function(n,t,r,o){var a,i=e(t);i.d.set(r,o.n);var u=y(i);u&&p(t,u,o),null==(a=o.m)||a.t.add(t),n&&function(n,e,t){var r=n[0].get(e);r&&r.add(t)}(n,r,t)},o=function n(o,a,i){var l=e(a);if((null==i||!i(a))&&s(l)){if(l.m)return l;if(Array.from(l.d).every((function(e){var t=e[0],r=e[1];return n(o,t,i).n===r})))return l}l.d.clear();var v,d,y=!0,p={get signal(){return v||(v=new AbortController),v.signal},get setSelf(){return!d&&c(a)&&(d=function(){if(!y){for(var n=arguments.length,e=new Array(n),t=0;t<n;t++)e[t]=arguments[t];return A.apply(void 0,[a].concat(e))}}),d}};try{var w=a.read((function(c){if(u(a,c)){var v=e(c);if(!s(v)){if(!f(c))throw new Error("no atom init");t(c,v,c.init)}return m(v)}var d=n(o,c,i);if(y)r(o,a,c,d);else{var p=h();r(p,a,c,d),k(p,a,l),b(p)}return m(d)}),p);return t(a,l,w,(function(){var n;return null==(n=v)?void 0:n.abort()}),(function(){if(l.m){var n=h();k(n,a,l),b(n)}})),l}catch(n){return delete l.v,l.e=n,++l.n,l}finally{y=!1}},i=function(n,t){var r=[],i=new Set;!function t(o){if(!i.has(o)){i.add(o);for(var u,f=a(function(t){for(var r,o,i,u=e(t),f=new Set(null==(r=u.m)?void 0:r.t),c=a(u.p);!(i=c()).done;){var l=i.value;f.add(l)}return null==(o=function(n,e){return n[0].get(e)}(n,t))||o.forEach((function(n){f.add(n)})),f}(o));!(u=f()).done;){var c=u.value;o!==c&&t(c)}r.push(o)}}(t);for(var u=new Set([t]),f=function(n){return i.has(n)},c=r.length-1;c>=0;--c){for(var l,v=r[c],d=e(v),s=d.n,m=!1,y=a(d.d.keys());!(l=y()).done;){var p=l.value;if(p!==v&&u.has(p)){m=!0;break}}m&&(o(n,v,f),k(n,v,d),s!==d.n&&(w(n,v,d),u.add(v))),i.delete(v)}},S=function n(r,a){for(var c=arguments.length,l=new Array(c>2?c-2:0),v=2;v<c;v++)l[v-2]=arguments[v];var d=a.write.apply(a,[function(n){return m(o(r,n))},function(o){for(var c,l=arguments.length,v=new Array(l>1?l-1:0),d=1;d<l;d++)v[d-1]=arguments[d];if(u(a,o)){if(!f(o))throw new Error("atom not writable");var s=e(o),m="v"in s,y=s.v,p=v[0];t(o,s,p),k(r,o,s),m&&Object.is(y,s.v)||(w(r,o,s),i(r,o))}else c=n.apply(void 0,[r,o].concat(v));return b(r),c}].concat(l));return d},A=function(n){for(var e=h(),t=arguments.length,r=new Array(t>1?t-1:0),o=1;o<t;o++)r[o-1]=arguments[o];var a=S.apply(void 0,[e,n].concat(r));return b(e),a},k=function(n,e,t){if(t.m&&!y(t)){for(var r,o=a(t.d.keys());!(r=o()).done;){var i=r.value;if(!t.m.d.has(i))j(n,i).t.add(e),t.m.d.add(i)}for(var u,f=a(t.m.d||[]);!(u=f()).done;){var c=u.value;if(!t.d.has(c)){var l=M(n,c);null==l||l.t.delete(e),t.m.d.delete(c)}}}},j=function n(t,r){var i=e(r);if(!i.m){o(t,r);for(var u,f=a(i.d.keys());!(u=f()).done;){var l=u.value;n(t,l).t.add(r)}if(i.m={l:new Set,d:new Set(i.d.keys()),t:new Set},c(r)&&r.onMount){var v=i.m,d=r.onMount;g(t,(function(){var n=d((function(){for(var n=arguments.length,e=new Array(n),o=0;o<n;o++)e[o]=arguments[o];return S.apply(void 0,[t,r].concat(e))}));n&&(v.u=n)}))}}return i.m},M=function n(t,r){var o=e(r);if(!o.m||o.m.l.size||Array.from(o.m.t).some((function(n){return e(n).m})))return o.m;var i=o.m.u;i&&g(t,i),delete o.m;for(var u,f=a(o.d.keys());!(u=f()).done;){var c=n(t,u.value);null==c||c.t.delete(r)}var v=y(o);v&&v[l](void 0,(function(){}))};return{get:function(n){return m(o(void 0,n))},set:A,sub:function(n,e){var t=h(),r=j(t,n);b(t);var o=r.l;return o.add(e),function(){o.delete(e);var t=h();M(t,n),b(t)}}}};n.atom=function(n,o){var a="atom"+ ++e,i={toString:function(){return a}};return"function"==typeof n?i.read=n:(i.init=n,i.read=t,i.write=r),o&&(i.write=o),i},n.createStore=S,n.getDefaultStore=function(){return i||(i=S()),i}}));
