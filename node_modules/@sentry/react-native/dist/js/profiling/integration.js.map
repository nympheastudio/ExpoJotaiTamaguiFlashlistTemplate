{"version":3,"file":"integration.js","sourceRoot":"","sources":["../../../src/js/profiling/integration.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable complexity */\nimport type { Hub } from '@sentry/core';\nimport { getActiveTransaction } from '@sentry/core';\nimport type { Envelope, Event, EventProcessor, Integration, ThreadCpuProfile, Transaction } from '@sentry/types';\nimport { logger, uuid4 } from '@sentry/utils';\nimport { Platform } from 'react-native';\n\nimport { isHermesEnabled } from '../utils/environment';\nimport { NATIVE } from '../wrapper';\nimport { PROFILE_QUEUE } from './cache';\nimport { MAX_PROFILE_DURATION_MS } from './constants';\nimport { convertToSentryProfile } from './convertHermesProfile';\nimport type { NativeAndroidProfileEvent, NativeProfileEvent } from './nativeTypes';\nimport type { AndroidCombinedProfileEvent, CombinedProfileEvent, HermesProfileEvent, ProfileEvent } from './types';\nimport {\n  addProfilesToEnvelope,\n  createHermesProfilingEvent,\n  enrichCombinedProfileWithEventContext,\n  findProfiledTransactionsFromEnvelope,\n} from './utils';\n\nconst MS_TO_NS: number = 1e6;\n\n/**\n * Profiling integration creates a profile for each transaction and adds it to the event envelope.\n *\n * @experimental\n */\nexport class HermesProfiling implements Integration {\n  /**\n   * @inheritDoc\n   */\n  public static id: string = 'HermesProfiling';\n\n  /**\n   * @inheritDoc\n   */\n  public name: string = HermesProfiling.id;\n\n  private _getCurrentHub?: () => Hub;\n\n  private _currentProfile:\n    | {\n        profile_id: string;\n        startTimestampNs: number;\n      }\n    | undefined;\n\n  private _currentProfileTimeout: number | undefined;\n\n  /**\n   * @inheritDoc\n   */\n  public setupOnce(_: (e: EventProcessor) => void, getCurrentHub: () => Hub): void {\n    if (!isHermesEnabled()) {\n      logger.log('[Profiling] Hermes is not enabled, not adding profiling integration.');\n      return;\n    }\n\n    this._getCurrentHub = getCurrentHub;\n    const client = getCurrentHub().getClient();\n\n    if (!client || typeof client.on !== 'function') {\n      return;\n    }\n\n    this._startCurrentProfileForActiveTransaction();\n    client.on('startTransaction', this._startCurrentProfile);\n\n    client.on('finishTransaction', this._finishCurrentProfile);\n\n    client.on('beforeEnvelope', (envelope: Envelope) => {\n      if (!PROFILE_QUEUE.size()) {\n        return;\n      }\n\n      const profiledTransactions = findProfiledTransactionsFromEnvelope(envelope);\n      if (!profiledTransactions.length) {\n        logger.log('[Profiling] no profiled transactions found in envelope');\n        return;\n      }\n\n      const profilesToAddToEnvelope: ProfileEvent[] = [];\n      for (const profiledTransaction of profiledTransactions) {\n        const profile = this._createProfileEventFor(profiledTransaction);\n        if (profile) {\n          profilesToAddToEnvelope.push(profile);\n        }\n      }\n      addProfilesToEnvelope(envelope, profilesToAddToEnvelope);\n    });\n  }\n\n  private _startCurrentProfileForActiveTransaction = (): void => {\n    if (this._currentProfile) {\n      return;\n    }\n    const transaction = this._getCurrentHub && getActiveTransaction(this._getCurrentHub());\n    transaction && this._startCurrentProfile(transaction);\n  };\n\n  private _startCurrentProfile = (transaction: Transaction): void => {\n    this._finishCurrentProfile();\n\n    const shouldStartProfiling = this._shouldStartProfiling(transaction);\n    if (!shouldStartProfiling) {\n      return;\n    }\n\n    this._currentProfileTimeout = setTimeout(this._finishCurrentProfile, MAX_PROFILE_DURATION_MS);\n    this._startNewProfile(transaction);\n  };\n\n  private _shouldStartProfiling = (transaction: Transaction): boolean => {\n    if (!transaction.sampled) {\n      logger.log('[Profiling] Transaction is not sampled, skipping profiling');\n      return false;\n    }\n\n    const client = this._getCurrentHub && this._getCurrentHub().getClient();\n    const options = client && client.getOptions();\n\n    const profilesSampleRate =\n      options && options._experiments && typeof options._experiments.profilesSampleRate === 'number'\n        ? options._experiments.profilesSampleRate\n        : undefined;\n    if (profilesSampleRate === undefined) {\n      logger.log('[Profiling] Profiling disabled, enable it by setting `profilesSampleRate` option to SDK init call.');\n      return false;\n    }\n\n    // Check if we should sample this profile\n    if (Math.random() > profilesSampleRate) {\n      logger.log('[Profiling] Skip profiling transaction due to sampling.');\n      return false;\n    }\n\n    return true;\n  };\n\n  /**\n   * Starts a new profile and links it to the transaction.\n   */\n  private _startNewProfile = (transaction: Transaction): void => {\n    const profileStartTimestampNs = startProfiling();\n    if (!profileStartTimestampNs) {\n      return;\n    }\n\n    this._currentProfile = {\n      profile_id: uuid4(),\n      startTimestampNs: profileStartTimestampNs,\n    };\n    transaction.setContext('profile', { profile_id: this._currentProfile.profile_id });\n    // @ts-expect-error profile_id is not part of the metadata type\n    transaction.setMetadata({ profile_id: this._currentProfile.profile_id });\n    logger.log('[Profiling] started profiling: ', this._currentProfile.profile_id);\n  };\n\n  /**\n   * Stops profiling and adds the profile to the queue to be processed on beforeEnvelope.\n   */\n  private _finishCurrentProfile = (): void => {\n    this._clearCurrentProfileTimeout();\n    if (this._currentProfile === undefined) {\n      return;\n    }\n\n    const profile = stopProfiling(this._currentProfile.startTimestampNs);\n    if (!profile) {\n      logger.warn('[Profiling] Stop failed. Cleaning up...');\n      this._currentProfile = undefined;\n      return;\n    }\n\n    PROFILE_QUEUE.add(this._currentProfile.profile_id, profile);\n\n    logger.log('[Profiling] finished profiling: ', this._currentProfile.profile_id);\n    this._currentProfile = undefined;\n  };\n\n  private _createProfileEventFor = (profiledTransaction: Event): ProfileEvent | null => {\n    const profile_id = profiledTransaction?.contexts?.['profile']?.['profile_id'];\n\n    if (typeof profile_id !== 'string') {\n      logger.log('[Profiling] cannot find profile for a transaction without a profile context');\n      return null;\n    }\n\n    // Remove the profile from the transaction context before sending, relay will take care of the rest.\n    if (profiledTransaction?.contexts?.['.profile']) {\n      delete profiledTransaction.contexts.profile;\n    }\n\n    const profile = PROFILE_QUEUE.get(profile_id);\n    PROFILE_QUEUE.delete(profile_id);\n\n    if (!profile) {\n      logger.log(`[Profiling] cannot find profile ${profile_id} for transaction ${profiledTransaction.event_id}`);\n      return null;\n    }\n\n    const profileWithEvent = enrichCombinedProfileWithEventContext(profile_id, profile, profiledTransaction);\n    logger.log(`[Profiling] Created profile ${profile_id} for transaction ${profiledTransaction.event_id}`);\n\n    return profileWithEvent;\n  };\n\n  private _clearCurrentProfileTimeout = (): void => {\n    this._currentProfileTimeout !== undefined && clearTimeout(this._currentProfileTimeout);\n    this._currentProfileTimeout = undefined;\n  };\n}\n\n/**\n * Starts Profilers and returns the timestamp when profiling started in nanoseconds.\n */\nexport function startProfiling(): number | null {\n  const started = NATIVE.startProfiling();\n  if (!started) {\n    return null;\n  }\n\n  return Date.now() * MS_TO_NS;\n}\n\n/**\n * Stops Profilers and returns collected combined profile.\n */\nexport function stopProfiling(\n  profileStartTimestampNs: number,\n): CombinedProfileEvent | AndroidCombinedProfileEvent | null {\n  const collectedProfiles = NATIVE.stopProfiling();\n  if (!collectedProfiles) {\n    return null;\n  }\n  const profileEndTimestampNs = Date.now() * MS_TO_NS;\n\n  const hermesProfile = convertToSentryProfile(collectedProfiles.hermesProfile);\n  if (!hermesProfile) {\n    return null;\n  }\n\n  const hermesProfileEvent = createHermesProfilingEvent(hermesProfile);\n  if (!hermesProfileEvent) {\n    return null;\n  }\n\n  if (collectedProfiles.androidProfile) {\n    const durationNs = profileEndTimestampNs - profileStartTimestampNs;\n    return createAndroidWithHermesProfile(hermesProfileEvent, collectedProfiles.androidProfile, durationNs);\n  } else if (collectedProfiles.nativeProfile) {\n    return addNativeProfileToHermesProfile(hermesProfileEvent, collectedProfiles.nativeProfile);\n  }\n\n  return hermesProfileEvent;\n}\n\n/**\n * Creates Android profile event with attached javascript profile.\n */\nexport function createAndroidWithHermesProfile(\n  hermes: HermesProfileEvent,\n  nativeAndroid: NativeAndroidProfileEvent,\n  durationNs: number,\n): AndroidCombinedProfileEvent {\n  return {\n    ...nativeAndroid,\n    platform: 'android',\n    js_profile: hermes.profile,\n    duration_ns: durationNs.toString(10),\n    active_thread_id: hermes.transaction.active_thread_id,\n  };\n}\n\n/**\n * Merges Hermes and Native profile events into one.\n */\nexport function addNativeProfileToHermesProfile(\n  hermes: HermesProfileEvent,\n  native: NativeProfileEvent,\n): CombinedProfileEvent {\n  return {\n    ...hermes,\n    profile: addNativeThreadCpuProfileToHermes(hermes.profile, native.profile, hermes.transaction.active_thread_id),\n    debug_meta: {\n      images: native.debug_meta.images,\n    },\n    measurements: native.measurements,\n  };\n}\n\n/**\n * Merges Hermes And Native profiles into one.\n */\nexport function addNativeThreadCpuProfileToHermes(\n  hermes: ThreadCpuProfile,\n  native: ThreadCpuProfile,\n  hermes_active_thread_id: string | undefined,\n): CombinedProfileEvent['profile'] {\n  // assumes thread ids are unique\n  hermes.thread_metadata = { ...native.thread_metadata, ...hermes.thread_metadata };\n  // assumes queue ids are unique\n  hermes.queue_metadata = { ...native.queue_metadata, ...hermes.queue_metadata };\n\n  // recalculate frames and stacks using offset\n  const framesOffset = hermes.frames.length;\n  const stacksOffset = hermes.stacks.length;\n\n  if (native.frames) {\n    for (const frame of native.frames) {\n      hermes.frames.push({\n        function: frame.function,\n        instruction_addr: frame.instruction_addr,\n        platform: Platform.OS === 'ios' ? 'cocoa' : undefined,\n      });\n    }\n  }\n  hermes.stacks = [\n    ...(hermes.stacks || []),\n    ...(native.stacks || []).map(stack => stack.map(frameId => frameId + framesOffset)),\n  ];\n  hermes.samples = [\n    ...(hermes.samples || []),\n    ...(native.samples || [])\n      .filter(sample => sample.thread_id !== hermes_active_thread_id)\n      .map(sample => ({\n        ...sample,\n        stack_id: stacksOffset + sample.stack_id,\n      })),\n  ];\n\n  return hermes;\n}\n"]}